<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SuperTool Site</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/img/icon-192.png" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- Google Identity Services：只載一次 -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* 小貼片樣式（顯示在帳號卡片標題下、回首頁按鈕上） */
    .welcome-chip{
      display:inline-flex;align-items:center;gap:.4rem;
      background:#ffffff; color:#111; border-radius:999px;
      padding:.35rem .7rem; font-weight:700; box-shadow:0 2px 8px #0003;
      margin: .5rem 0 1rem 0;
    }
    /* ---- 右側購物車面板 ---- */
.cart-mask{
  position:fixed; inset:0; background:#0007; 
  opacity:0; pointer-events:none; transition:.25s;
  z-index: 8888;
}
.cart-mask.open{ opacity:1; pointer-events:auto; }

.cart-panel{
  position:fixed; top:0; right:0; height:100vh; width:360px;
  background:#111; color:#eee; box-shadow:-8px 0 24px #0008;
  transform: translateX(100%); transition:.25s;
  display:flex; flex-direction:column; z-index:8890;
  border-left:1px solid #333;
}
.cart-panel.open{ transform: translateX(0); }

.cart-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px; border-bottom:1px solid #2a2a2a; font-weight:700;
}
.cart-body{ padding:12px 16px; gap:8px; overflow:auto; flex:1; }
.cart-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 0; border-bottom:1px solid #1e1e1e; }
.cart-qty button{ background:#222; border:1px solid #333; color:#eee; width:28px; height:28px; border-radius:6px; }
.cart-qty span{ min-width:28px; text-align:center; display:inline-block; }
.cart-foot{ padding:14px 16px; border-top:1px solid #2a2a2a; }
.cart-row{ display:flex; justify-content:space-between; margin:6px 0; }
.cart-total{ font-size:18px; font-weight:800; }
.cart-actions{ display:flex; gap:8px; margin-top:10px; }
.cart-actions button, .cart-actions a{
  flex:1; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#222; color:#eee; text-align:center; text-decoration:none;
}
.cart-actions a.btn-primary{ background:#4a6cff; border-color:#4a6cff; }
.badge-dot{
  position:absolute; right:-6px; top:-6px; background:#ff5b5b; color:#fff; font-size:12px;
  border-radius:999px; padding:2px 6px; line-height:1; border:2px solid #111;
}

  </style>
</head>
<body>

<header class="top">
  <div class="brand">SuperTool</div>
  <nav class="nav">
    <button data-route="dashboard">首頁</button>
    <button data-route="auth">帳號</button>
    <button data-route="expense">支出</button>
    <button data-route="acct_mine">我的</button>
    <button data-route="acct_detail">明細</button>
    <button data-route="acct_analysis">分析</button>
    <button data-route="chatbook">聊天記帳</button>
    <button data-route="camera">拍照記帳</button>
    <button data-route="shop">購物</button>
    <button data-route="admin">後台</button>
    <button data-route="settings">設定</button>
    <button data-route="backup">備份</button>
  </nav>
</header>

<main id="app"></main>

<button id="fabExpense" class="fab">＋</button>
<button id="fabShop" class="fab-square">🛒</button>

<script type="module" src="assets/js/app.js"></script>
  <!-- 購物車：遮罩 + 右側面板 -->
<div id="cartMask" class="cart-mask"></div>
<div id="cartPanel" class="cart-panel" aria-hidden="true">
  <div class="cart-head">
    <div>購物車</div>
    <button id="cartClose" class="btn" style="background:#222;border:1px solid #333;color:#eee;padding:.4rem .7rem;border-radius:8px">關閉</button>
  </div>

  <div id="cartItems" class="cart-body"><div class="text-muted">尚無商品</div></div>

  <div class="cart-foot">
    <div class="cart-row"><span class="text-muted">小計</span><span id="cartSubtotal">NT$ 0</span></div>
    <div class="cart-row"><span class="text-muted">運費</span><span id="cartShipping">NT$ 0</span></div>
    <div class="cart-row cart-total"><span>合計</span><span id="cartTotal">NT$ 0</span></div>
    <div class="cart-actions">
      <button id="cartClear">清空</button>
      <a href="#shop" class="btn-primary">前往結帳</a> <!-- 或改成你的結帳頁 -->
    </div>
  </div>
</div>


<script>
/* ------------------ 共用：JWT 解析（避免中文亂碼） ------------------ */
function parseGoogleJWT(credential){
  const base64Url = credential.split('.')[1];
  const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
  const json = decodeURIComponent(
    atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
  );
  return JSON.parse(json);
}

/* ------------------ 共用：在帳號卡片顯示歡迎 ------------------ */
window.__showWelcomeInAuth = function(name){
  // 優先找 #welcome-slot，找不到就自動建立到帳號卡片頂端
  let slot = document.getElementById('welcome-slot');
  if(!slot){
    const card = document.querySelector('#auth-card');
    if(card){
      slot = document.createElement('div');
      slot.id = 'welcome-slot';
      card.insertBefore(slot, card.firstChild ? card.firstChild.nextSibling : null);
    }
  }
  if(slot){
    slot.innerHTML = `<div class="welcome-chip">👋 歡迎 ${name}</div>`;
  }
};

/* ------------------ Google 初始化 & 登入回呼 ------------------ */
function handleCredentialResponse(res){
  try{
    const payload = parseGoogleJWT(res.credential);
    const user = {
      email:   payload.email,
      name:    payload.name,
      picture: payload.picture,
      sub:     payload.sub
    };
    localStorage.setItem('session_user', JSON.stringify(user));
    try{ google.accounts.id.cancel(); }catch(e){}

    // 若目前在帳號頁，直接顯示歡迎
    window.__showWelcomeInAuth && window.__showWelcomeInAuth(user.name);

    // 通知頁面（若你有路由或需要刷新）
    if(location.hash === '#auth'){
      // 不重整也可，只要你的 SPA 會讀 localStorage 就好
    }else{
      // 登入完直接回首頁（選用）
      location.hash = '#dashboard';
    }
  }catch(e){
    console.error('解析 Google Token 失敗：', e);
  }
}

function initGoogle(){
  if(!window.google || !google.accounts || !google.accounts.id) return;

  google.accounts.id.initialize({
    client_id: "225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com",
    callback: handleCredentialResponse,
    auto_select: false,           // ❌ 不自動 One-Tap
    cancel_on_tap_outside: true   // ❌ 不顯示左上角膠囊
  });

  // 把 renderButton 變成全域可呼叫（在 auth.js 會使用）
  window.__renderGoogleBtn = function(){
    const mount = document.getElementById('googleBtnMount') || document.querySelector('.g_id_signin');
    if(mount){
      google.accounts.id.renderButton(mount, { theme: "outline", size: "large" });
    }
  };

  // 若已登入，切到帳號頁時顯示歡迎；未登入則渲染按鈕
  function refreshAuthUI(){
    let user = null;
    try{ user = JSON.parse(localStorage.getItem('session_user') || 'null'); }catch{}
    if(location.hash === '#auth'){
      if(user && user.name){
        window.__showWelcomeInAuth && window.__showWelcomeInAuth(user.name);
      }else{
        window.__renderGoogleBtn && window.__renderGoogleBtn();
      }
    }
  }

  // 首次載入
  refreshAuthUI();

  // hash 變化時再檢查一次
  window.addEventListener('hashchange', refreshAuthUI);
}

window.addEventListener('load', () => {
  // 初始化 GSI
  const ready = () => initGoogle();
  if(window.google && google.accounts && google.accounts.id){ ready(); }
  else {
    // 等 script 載入完成
    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      if(window.google && google.accounts && google.accounts.id){
        clearInterval(timer);
        ready();
      }else if(tries > 50){ // 最多等 5 秒
        clearInterval(timer);
      }
    }, 100);
  }
});
</script>

<script>
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
</body>
</html>

