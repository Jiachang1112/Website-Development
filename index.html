<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SuperTool Site</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/img/icon-192.png" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- Google Identity Servicesï¼šåªè¼‰ä¸€æ¬¡ -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* å°è²¼ç‰‡æ¨£å¼ï¼ˆé¡¯ç¤ºåœ¨å¸³è™Ÿå¡ç‰‡æ¨™é¡Œä¸‹ã€å›é¦–é æŒ‰éˆ•ä¸Šï¼‰ */
    .welcome-chip{
      display:inline-flex;align-items:center;gap:.4rem;
      background:#ffffff; color:#111; border-radius:999px;
      padding:.35rem .7rem; font-weight:700; box-shadow:0 2px 8px #0003;
      margin: .5rem 0 1rem 0;
    }
  </style>
</head>
  <!-- Google Identity Servicesï¼šä½ å·²ç¶“æœ‰ -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Firebase SDK (v12 æ¨¡çµ„ç‰ˆ) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithCredential,
    onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc,
    collection, addDoc, serverTimestamp,
    query, where, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  // === 1) Firebase å°ˆæ¡ˆè¨­å®šï¼ˆæ›æˆä½ çš„ï¼‰ ===
  const firebaseConfig = {
    apiKey: "AIzaSyCjrjZOyMrzlbG2VOoRqd9o3q3X5HYv2WY",
    authDomain: "supertool-dee80.firebaseapp.com",
    projectId: "supertool-dee80",
    storageBucket: "supertool-dee80.firebasestorage.app",
    messagingSenderId: "577771534429",
    appId: "1:577771534429:web:7dc10a6082e9ab1cfd35b4"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // === 2) GSI callbackï¼šæŠŠ Google çš„ JWT äº¤çµ¦ Firebase Auth ===
  window.handleCredentialResponse = async (res) => {
    try {
      const credential = GoogleAuthProvider.credential(res.credential);
      await signInWithCredential(auth, credential);
      // æœƒè§¸ç™¼ onAuthStateChanged
    } catch (err) {
      console.error('ç™»å…¥å¤±æ•—ï¼š', err);
      alert('ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  // === 3) ç›£è½ç™»å…¥ç‹€æ…‹ ===
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // æœªç™»å…¥ â†’ é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('appBox').style.display   = 'none';
      return;
    }

    // å·²ç™»å…¥ â†’ éš±è—ç™»å…¥ï¼Œé¡¯ç¤º app
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('appBox').style.display   = 'block';
    document.getElementById('hello').textContent = `å—¨ï¼Œ${user.displayName || user.email}`;

    // ç¢ºä¿ users æ–‡ä»¶å­˜åœ¨ï¼ˆmerge=true å¯é‡è¤‡å‘¼å«ï¼‰
    const userRef = doc(db, 'users', user.uid);
    await setDoc(userRef, {
      uid: user.uid,
      name: user.displayName || '',
      email: user.email || '',
      picture: user.photoURL || '',
      updatedAt: serverTimestamp()
    }, { merge: true });

    // å•Ÿå‹•ç›£è½ç›®å‰ä½¿ç”¨è€…çš„è¨˜å¸³æ¸…å–®
    startListenMyExpenses(user.uid);
  });

  // === 4) æ–°å¢è¨˜å¸³ ===
  async function addExpense(evt) {
    evt.preventDefault();
    const user = auth.currentUser;
    if (!user) return alert('å°šæœªç™»å…¥');

    const amount   = Number(document.getElementById('fAmount').value || 0);
    const category = document.getElementById('fCategory').value.trim();
    const note     = document.getElementById('fNote').value.trim();

    if (!amount || !category) return alert('é‡‘é¡èˆ‡åˆ†é¡å¿…å¡«');

    await addDoc(collection(db, 'expenses'), {
      uid: user.uid,
      amount,
      category,
      note,
      createdAt: serverTimestamp()
    });

    // æ¸…ç©ºè¡¨å–®
    document.getElementById('expenseForm').reset();
  }

  document.getElementById('expenseForm').addEventListener('submit', addExpense);

  // === 5) ç›£è½è‡ªå·±çš„è¨˜å¸³ ===
  let unSub = null;
  function startListenMyExpenses(uid) {
    if (unSub) unSub(); // å…ˆå–æ¶ˆèˆŠçš„ç›£è½
    const q = query(
      collection(db, 'expenses'),
      where('uid', '==', uid),
      orderBy('createdAt', 'desc')
    );
    unSub = onSnapshot(q, (snap) => {
      const list = [];
      snap.forEach(doc => {
        const d = doc.data();
        list.push({
          id: doc.id,
          amount: d.amount,
          category: d.category,
          note: d.note || '',
          createdAt: d.createdAt?.toDate?.() || null
        });
      });
      renderExpenses(list);
    });
  }

  function renderExpenses(items) {
    const ul = document.getElementById('myList');
    ul.innerHTML = '';
    items.forEach(it => {
      const li = document.createElement('li');
      const d  = it.createdAt ? it.createdAt.toLocaleString() : '';
      li.textContent = `${d}ï½œ${it.category}ï½œ$${it.amount}ï½œ${it.note}`;
      ul.appendChild(li);
    });
  }

  // === 6) ç™»å‡º ===
  document.getElementById('btnLogout').addEventListener('click', async () => {
    await signOut(auth);
  });
</script>

<body>
  <!-- ç™»å…¥å€å¡Š -->
<div id="loginBox" style="display:none; margin: 24px;">
  <h3>è«‹ç”¨ Google ç™»å…¥</h3>
  <!-- GSIï¼šæŒ‡å®š callback -->
  <div id="g_id_onload"
       data-client_id="225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"></div>

  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="signin_with"
       data-shape="rectangular"
       data-logo_alignment="left"></div>
</div>

<!-- App å€å¡Š -->
<div id="appBox" style="display:none; margin: 24px;">
  <div style="display:flex; justify-content:space-between;">
    <h3 id="hello"></h3>
    <button id="btnLogout">ç™»å‡º</button>
  </div>

  <!-- æ–°å¢è¨˜å¸³ -->
  <form id="expenseForm" style="margin:12px 0;">
    <input id="fAmount" type="number" placeholder="é‡‘é¡" min="1" required />
    <input id="fCategory" type="text" placeholder="åˆ†é¡ï¼ˆå¦‚ï¼šé¤é£²ï¼‰" required />
    <input id="fNote" type="text" placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰" />
    <button type="submit">æ–°å¢è¨˜å¸³</button>
  </form>

  <!-- æˆ‘çš„è¨˜å¸³æ¸…å–® -->
  <ul id="myList"></ul>
</div>


<header class="top">
  <div class="brand">SuperTool</div>
  <nav class="nav">
    <button data-route="dashboard">é¦–é </button>
    <button data-route="auth">å¸³è™Ÿ</button>
    <button data-route="expense">æ”¯å‡º</button>
    <button data-route="acct_mine">æˆ‘çš„</button>
    <button data-route="acct_detail">æ˜ç´°</button>
    <button data-route="acct_analysis">åˆ†æ</button>
    <button data-route="chatbook">èŠå¤©è¨˜å¸³</button>
    <button data-route="camera">æ‹ç…§è¨˜å¸³</button>
    <button data-route="shop">è³¼ç‰©</button>
    <button data-route="admin">å¾Œå°</button>
    <button data-route="settings">è¨­å®š</button>
    <button data-route="backup">å‚™ä»½</button>
  </nav>
</header>

<main id="app"></main>

<button id="fabExpense" class="fab">ï¼‹</button>
<button id="fabShop" class="fab-square">ğŸ›’</button>

<script type="module" src="assets/js/app.js"></script>

<script>
/* ------------------ å…±ç”¨ï¼šJWT è§£æï¼ˆé¿å…ä¸­æ–‡äº‚ç¢¼ï¼‰ ------------------ */
function parseGoogleJWT(credential){
  const base64Url = credential.split('.')[1];
  const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
  const json = decodeURIComponent(
    atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
  );
  return JSON.parse(json);
}

/* ------------------ å…±ç”¨ï¼šåœ¨å¸³è™Ÿå¡ç‰‡é¡¯ç¤ºæ­¡è¿ ------------------ */
window.__showWelcomeInAuth = function(name){
  // å„ªå…ˆæ‰¾ #welcome-slotï¼Œæ‰¾ä¸åˆ°å°±è‡ªå‹•å»ºç«‹åˆ°å¸³è™Ÿå¡ç‰‡é ‚ç«¯
  let slot = document.getElementById('welcome-slot');
  if(!slot){
    const card = document.querySelector('#auth-card');
    if(card){
      slot = document.createElement('div');
      slot.id = 'welcome-slot';
      card.insertBefore(slot, card.firstChild ? card.firstChild.nextSibling : null);
    }
  }
  if(slot){
    slot.innerHTML = `<div class="welcome-chip">ğŸ‘‹ æ­¡è¿ ${name}</div>`;
  }
};

/* ------------------ Google åˆå§‹åŒ– & ç™»å…¥å›å‘¼ ------------------ */
function handleCredentialResponse(res){
  try{
    const payload = parseGoogleJWT(res.credential);
    const user = {
      email:   payload.email,
      name:    payload.name,
      picture: payload.picture,
      sub:     payload.sub
    };
    localStorage.setItem('session_user', JSON.stringify(user));
    try{ google.accounts.id.cancel(); }catch(e){}

    // è‹¥ç›®å‰åœ¨å¸³è™Ÿé ï¼Œç›´æ¥é¡¯ç¤ºæ­¡è¿
    window.__showWelcomeInAuth && window.__showWelcomeInAuth(user.name);

    // é€šçŸ¥é é¢ï¼ˆè‹¥ä½ æœ‰è·¯ç”±æˆ–éœ€è¦åˆ·æ–°ï¼‰
    if(location.hash === '#auth'){
      // ä¸é‡æ•´ä¹Ÿå¯ï¼Œåªè¦ä½ çš„ SPA æœƒè®€ localStorage å°±å¥½
    }else{
      // ç™»å…¥å®Œç›´æ¥å›é¦–é ï¼ˆé¸ç”¨ï¼‰
      location.hash = '#dashboard';
    }
  }catch(e){
    console.error('è§£æ Google Token å¤±æ•—ï¼š', e);
  }
}

function initGoogle(){
  if(!window.google || !google.accounts || !google.accounts.id) return;

  google.accounts.id.initialize({
    client_id: "225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com",
    callback: handleCredentialResponse,
    auto_select: false,           // âŒ ä¸è‡ªå‹• One-Tap
    cancel_on_tap_outside: true   // âŒ ä¸é¡¯ç¤ºå·¦ä¸Šè§’è† å›Š
  });

  // æŠŠ renderButton è®Šæˆå…¨åŸŸå¯å‘¼å«ï¼ˆåœ¨ auth.js æœƒä½¿ç”¨ï¼‰
  window.__renderGoogleBtn = function(){
    const mount = document.getElementById('googleBtnMount') || document.querySelector('.g_id_signin');
    if(mount){
      google.accounts.id.renderButton(mount, { theme: "outline", size: "large" });
    }
  };

  // è‹¥å·²ç™»å…¥ï¼Œåˆ‡åˆ°å¸³è™Ÿé æ™‚é¡¯ç¤ºæ­¡è¿ï¼›æœªç™»å…¥å‰‡æ¸²æŸ“æŒ‰éˆ•
  function refreshAuthUI(){
    let user = null;
    try{ user = JSON.parse(localStorage.getItem('session_user') || 'null'); }catch{}
    if(location.hash === '#auth'){
      if(user && user.name){
        window.__showWelcomeInAuth && window.__showWelcomeInAuth(user.name);
      }else{
        window.__renderGoogleBtn && window.__renderGoogleBtn();
      }
    }
  }

  // é¦–æ¬¡è¼‰å…¥
  refreshAuthUI();

  // hash è®ŠåŒ–æ™‚å†æª¢æŸ¥ä¸€æ¬¡
  window.addEventListener('hashchange', refreshAuthUI);
}

window.addEventListener('load', () => {
  // åˆå§‹åŒ– GSI
  const ready = () => initGoogle();
  if(window.google && google.accounts && google.accounts.id){ ready(); }
  else {
    // ç­‰ script è¼‰å…¥å®Œæˆ
    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      if(window.google && google.accounts && google.accounts.id){
        clearInterval(timer);
        ready();
      }else if(tries > 50){ // æœ€å¤šç­‰ 5 ç§’
        clearInterval(timer);
      }
    }, 100);
  }
});
</script>

<script>
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
</body>
</html>
