<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SuperTool Site</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/img/icon-192.png" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- Google Identity Servicesï¼šåªè¼‰ä¸€æ¬¡ -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* å°è²¼ç‰‡æ¨£å¼ï¼ˆé¡¯ç¤ºåœ¨å¸³è™Ÿå¡ç‰‡æ¨™é¡Œä¸‹ã€å›é¦–é æŒ‰éˆ•ä¸Šï¼‰ */
    .welcome-chip{
      display:inline-flex;align-items:center;gap:.4rem;
      background:#ffffff; color:#111; border-radius:999px;
      padding:.35rem .7rem; font-weight:700; box-shadow:0 2px 8px #0003;
      margin: .5rem 0 1rem 0;
    }
  </style>
</head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<body>

<header class="top">
  <div class="brand">SuperTool</div>
  <nav class="nav">
    <button data-route="dashboard">é¦–é </button>
    <button data-route="auth">å¸³è™Ÿ</button>
    <button data-route="expense">æ”¯å‡º</button>
    <button data-route="acct_mine">æˆ‘çš„</button>
    <button data-route="acct_detail">æ˜ç´°</button>
    <button data-route="acct_analysis">åˆ†æ</button>
    <button data-route="chatbook">èŠå¤©è¨˜å¸³</button>
    <button data-route="camera">æ‹ç…§è¨˜å¸³</button>
    <button data-route="shop">è³¼ç‰©</button>
    <button data-route="admin">å¾Œå°</button>
    <button data-route="settings">è¨­å®š</button>
    <button data-route="backup">å‚™ä»½</button>
  </nav>
</header>

<main id="app"></main>

<button id="fabExpense" class="fab">ï¼‹</button>
<button id="fabShop" class="fab-square">ğŸ›’</button>

<script type="module" src="assets/js/app.js"></script>
<main id="app"></main>

<!-- å·¦ä¸‹è§’æµ®å‹•è³¼ç‰©è»Š -->
<button class="btn btn-dark rounded-circle p-3 position-fixed bottom-0 start-0 m-3"
        data-bs-toggle="offcanvas" data-bs-target="#cartPanel">
  <i class="bi bi-cart"></i>
</button>

<button id="fabExpense" class="fab">ï¼‹</button>
<button id="fabShop" class="fab-square">ğŸ›’</button>

<script>
/* ------------------ å…±ç”¨ï¼šJWT è§£æï¼ˆé¿å…ä¸­æ–‡äº‚ç¢¼ï¼‰ ------------------ */
function parseGoogleJWT(credential){
  const base64Url = credential.split('.')[1];
  const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
  const json = decodeURIComponent(
    atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
  );
  return JSON.parse(json);
}

/* ------------------ å…±ç”¨ï¼šåœ¨å¸³è™Ÿå¡ç‰‡é¡¯ç¤ºæ­¡è¿ ------------------ */
window.__showWelcomeInAuth = function(name){
  // å„ªå…ˆæ‰¾ #welcome-slotï¼Œæ‰¾ä¸åˆ°å°±è‡ªå‹•å»ºç«‹åˆ°å¸³è™Ÿå¡ç‰‡é ‚ç«¯
  let slot = document.getElementById('welcome-slot');
  if(!slot){
    const card = document.querySelector('#auth-card');
    if(card){
      slot = document.createElement('div');
      slot.id = 'welcome-slot';
      card.insertBefore(slot, card.firstChild ? card.firstChild.nextSibling : null);
    }
  }
  if(slot){
    slot.innerHTML = `<div class="welcome-chip">ğŸ‘‹ æ­¡è¿ ${name}</div>`;
  }
};

/* ------------------ Google åˆå§‹åŒ– & ç™»å…¥å›å‘¼ ------------------ */
function handleCredentialResponse(res){
  try{
    const payload = parseGoogleJWT(res.credential);
    const user = {
      email:   payload.email,
      name:    payload.name,
      picture: payload.picture,
      sub:     payload.sub
    };
    localStorage.setItem('session_user', JSON.stringify(user));
    try{ google.accounts.id.cancel(); }catch(e){}

    // è‹¥ç›®å‰åœ¨å¸³è™Ÿé ï¼Œç›´æ¥é¡¯ç¤ºæ­¡è¿
    window.__showWelcomeInAuth && window.__showWelcomeInAuth(user.name);

    // é€šçŸ¥é é¢ï¼ˆè‹¥ä½ æœ‰è·¯ç”±æˆ–éœ€è¦åˆ·æ–°ï¼‰
    if(location.hash === '#auth'){
      // ä¸é‡æ•´ä¹Ÿå¯ï¼Œåªè¦ä½ çš„ SPA æœƒè®€ localStorage å°±å¥½
    }else{
      // ç™»å…¥å®Œç›´æ¥å›é¦–é ï¼ˆé¸ç”¨ï¼‰
      location.hash = '#dashboard';
    }
  }catch(e){
    console.error('è§£æ Google Token å¤±æ•—ï¼š', e);
  }
}

function initGoogle(){
  if(!window.google || !google.accounts || !google.accounts.id) return;

  google.accounts.id.initialize({
    client_id: "225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com",
    callback: handleCredentialResponse,
    auto_select: false,           // âŒ ä¸è‡ªå‹• One-Tap
    cancel_on_tap_outside: true   // âŒ ä¸é¡¯ç¤ºå·¦ä¸Šè§’è† å›Š
  });

  // æŠŠ renderButton è®Šæˆå…¨åŸŸå¯å‘¼å«ï¼ˆåœ¨ auth.js æœƒä½¿ç”¨ï¼‰
  window.__renderGoogleBtn = function(){
    const mount = document.getElementById('googleBtnMount') || document.querySelector('.g_id_signin');
    if(mount){
      google.accounts.id.renderButton(mount, { theme: "outline", size: "large" });
    }
  };

  // è‹¥å·²ç™»å…¥ï¼Œåˆ‡åˆ°å¸³è™Ÿé æ™‚é¡¯ç¤ºæ­¡è¿ï¼›æœªç™»å…¥å‰‡æ¸²æŸ“æŒ‰éˆ•
  function refreshAuthUI(){
    let user = null;
    try{ user = JSON.parse(localStorage.getItem('session_user') || 'null'); }catch{}
    if(location.hash === '#auth'){
      if(user && user.name){
        window.__showWelcomeInAuth && window.__showWelcomeInAuth(user.name);
      }else{
        window.__renderGoogleBtn && window.__renderGoogleBtn();
      }
    }
  }

  // é¦–æ¬¡è¼‰å…¥
  refreshAuthUI();

  // hash è®ŠåŒ–æ™‚å†æª¢æŸ¥ä¸€æ¬¡
  window.addEventListener('hashchange', refreshAuthUI);
}

window.addEventListener('load', () => {
  // åˆå§‹åŒ– GSI
  const ready = () => initGoogle();
  if(window.google && google.accounts && google.accounts.id){ ready(); }
  else {
    // ç­‰ script è¼‰å…¥å®Œæˆ
    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      if(window.google && google.accounts && google.accounts.id){
        clearInterval(timer);
        ready();
      }else if(tries > 50){ // æœ€å¤šç­‰ 5 ç§’
        clearInterval(timer);
      }
    }, 100);
  }
});
</script>

<script>
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
</body>
</html>
