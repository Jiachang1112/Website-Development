<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SuperTool Site</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    #onetap-anchor { position: fixed; top: 8px; left: 8px; z-index: 9999; }
    .welcome-chip {
      display: inline-flex; align-items: center; gap: .4em;
      background: #fff; color: #111; border-radius: 999px;
      padding: .35rem .7rem; font-weight: 700;
      box-shadow: 0 2px 8px #0003;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- ‰Ω†ÁöÑ App ‰∏ªÈ´î -->
    <h1>SuperTool</h1>
    <div id="page"></div>
  </div>

  <!-- One Tap È°ØÁ§∫ÂçÄ -->
  <div id="onetap-anchor"></div>

  <!-- ‰Ω†ÁöÑÊáâÁî®Á®ãÂºè‰∏ªÁ®ãÂºè (router / UI Á≠â) -->
  <script src="assets/js/app.js"></script>

  <!-- Google One-Tap ÂàùÂßãÂåñ -->
  <script>
    // Ëß£Êûê Google JWTÔºàÈÅøÂÖç‰∏≠Êñá‰∫ÇÁ¢ºÔºâ
    function parseGoogleJWT(credential){
      const base64Url = credential.split('.')[1];
      const base64    = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      const json = decodeURIComponent(
        atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
      );
      return JSON.parse(json);
    }

    // È°ØÁ§∫Â∞èË≤ºÁâá
    function showWelcomeChip(name){
      const anchor = document.getElementById('onetap-anchor');
      if(!anchor) return;
      anchor.innerHTML = `<div class="welcome-chip">üëã Ê≠°Ëøé ${name}</div>`;
    }

    // Google ÂõûÂÇ≥ callback
    function handleCredentialResponse(res){
      try{
        const payload = parseGoogleJWT(res.credential);
        const user = {
          email:   payload.email,
          name:    payload.name,
          picture: payload.picture,
          sub:     payload.sub
        };
        localStorage.setItem('session_user', JSON.stringify(user));
        try{ google.accounts.id.cancel(); }catch(e){}
        showWelcomeChip(user.name);

        // Âº∑Âà∂Âà∑Êñ∞È†ÅÈù¢ or Ë∑ØÁî±
        location.hash = '#dashboard';
        location.reload();
      }catch(e){
        console.error('Ëß£Êûê Google Token Â§±ÊïóÔºö', e);
      }
    }

    // ÂàùÂßãÂåñ Google One-Tap
    window.addEventListener('load', () => {
      try{ google.accounts.id.disableAutoSelect(); }catch(e){}

      google.accounts.id.initialize({
        client_id: "225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com",
        callback: handleCredentialResponse,
        auto_select: false,
        cancel_on_tap_outside: true
      });

      // Ê™¢Êü• session ‚Üí Ê±∫ÂÆöË¶Å‰∏çË¶ÅÂè´ One-Tap
      try{
        const user = JSON.parse(localStorage.getItem('session_user') || 'null');
        if(!user){ google.accounts.id.prompt(); }
        else { showWelcomeChip(user.name); }
      }catch(e){}
    });

    // Áõ£ËÅΩ hash ÊèõÈ†Å ‚Üí Êú™ÁôªÂÖ•Â∞±ÂÜçË©¶ËëóÂè´ One-Tap
    window.addEventListener('hashchange', () => {
      try{
        const user = JSON.parse(localStorage.getItem('session_user') || 'null');
        if(!user){ google.accounts.id.prompt(); }
      }catch(e){}
    });
  </script>
</body>
</html>
