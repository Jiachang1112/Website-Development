<!doctype html><html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SuperTool Site</title>
<link rel="manifest" href="manifest.json"/>
<link rel="icon" href="assets/img/icon-192.png"/>
<link rel="stylesheet" href="assets/css/style.css"/>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
  <style>
  #onetap-anchor{position:fixed;top:6px;left:8px;z-index:9999}
  .welcome-chip{
    display:inline-flex;align-items:center;gap:.4rem;
    background:#ffffff; color:#111; border-radius:999px;
    padding:.35rem .7rem; font-weight:700; box-shadow:0 2px 8px #0003;
  }
</style>
<div id="onetap-anchor"></div>
<body>
  <!-- 放在 <head> 結束前或 <body> 開頭都可以 -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- 顯示 Google 登入按鈕 -->
<div class="g_id_signin"
     data-type="standard"
     data-shape="rectangular"
     data-theme="outline"
     data-text="sign_in_with"
     data-size="large"
     data-logo_alignment="left"></div>

<script>
  // 讀取/寫入使用者
  function getUser(){ try{ return JSON.parse(localStorage.getItem('session_user')||'null'); }catch{return null;} }
  function showWelcomeChip(name){
    const anchor = document.getElementById('onetap-anchor');
    anchor.innerHTML = `<div class="welcome-chip">👋 歡迎 ${name}</div>`;
  }

  // Google 回傳 credential 後執行（含正確的中文解碼）
  function handleCredentialResponse(response){
    try{
      const token = response.credential;
      const base64Url = token.split('.')[1];
      const base64    = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      const json = decodeURIComponent(
        atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
      );
      const payload = JSON.parse(json);

      const user = {
        email:   payload.email,
        name:    payload.name,
        picture: payload.picture,
        sub:     payload.sub
      };
      localStorage.setItem('session_user', JSON.stringify(user));

      // 登入後：關閉 One-Tap 並顯示歡迎
      try{ google.accounts.id.cancel(); }catch(e){}
      showWelcomeChip(user.name);

      // 讓你的 app 讀到新 session（若不需要可移除）
      location.hash = '#dashboard';
      location.reload();
    }catch(e){
      console.error('解析 Google Token 錯誤：', e);
    }
  }

  // ===== 初始化（關鍵）=====
  window.addEventListener('load', () => {
    // 先清除自動選取狀態，避免殘留
    try{ google.accounts.id.disableAutoSelect(); }catch(e){}

    // 初始化：不要 auto_select，callback 指向上面那個函式
    google.accounts.id.initialize({
      client_id: "225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com",
      callback: handleCredentialResponse,
      auto_select: false,
      cancel_on_tap_outside: true
    });

    const user = getUser();
    if (user && user.name){
      // 已登入：不顯示 One-Tap，直接顯示歡迎徽章
      showWelcomeChip(user.name);
    }else{
      // 未登入：叫出 One-Tap 小膠囊
      google.accounts.id.prompt();
    }
  });

  <script>
  // 只要 hash 換頁且未登入，就再嘗試叫出 One-Tap
  window.addEventListener('hashchange', () => {
    try {
      const user = JSON.parse(localStorage.getItem('session_user') || 'null');
      if (!user) { google.accounts.id.prompt(); }
    } catch {}
  });
</script>


<header class="top">
  <div class="brand">SuperTool</div>
  <nav class="nav">
    <button data-route="dashboard">首頁</button>
    <button data-route="auth">帳號</button>
    <button data-route="expense">支出</button>
    <button data-route="acct_mine">我的</button>
    <button data-route="acct_detail">明細</button>
    <button data-route="acct_analysis">分析</button>
    <button data-route="chatbook">聊天記帳</button>
    <button data-route="camera">拍照記帳</button>
    <button data-route="shop">購物</button>
    <button data-route="admin">後台</button>
    <button data-route="settings">設定</button>
    <button data-route="backup">備份</button>
  </nav>
</header>
  <style>
  #onetap-anchor{position:fixed;top:6px;left:8px;z-index:9999}
  .welcome-chip{
    display:inline-flex;align-items:center;gap:.4rem;
    background:#ffffff; color:#111; border-radius:999px;
    padding:.35rem .7rem; font-weight:700; box-shadow:0 2px 8px #0003;
  }
</style>
<div id="onetap-anchor"></div>

<main id="app"></main>

<button id="fabExpense" class="fab">＋</button>
<button id="fabShop" class="fab-square">🛒</button>

<script type="module" src="assets/js/app.js"></script>
<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
</body></html>
