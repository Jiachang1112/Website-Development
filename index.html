<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SuperTool Site</title>
<link rel="manifest" href="manifest.json"/>
<link rel="icon" href="assets/img/icon-192.png"/>
<link rel="stylesheet" href="assets/css/style.css"/>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  /* 小貼片樣式 */
  #onetap-anchor {
    position: fixed;
    top: 8px;
    left: 8px;
    z-index: 9999;
  }
  .welcome-chip {
    display: inline-flex;
    align-items: center;
    gap: .4em;
    background: #fff;
    color: #111;
    border-radius: 999px;
    padding: .35rem .7rem;
    font-weight: 700;
    box-shadow: 0 2px 8px #0003;
  }
</style>
</head>
<body>
  <!-- 顯示「歡迎 {name}」的小貼片位置 -->
  <div id="onetap-anchor"></div>

  <!-- Google One Tap 初始化 -->
  <div id="g_id_onload"
       data-client_id="225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com"
       data-auto_prompt="false"
       data-callback="handleCredentialResponse"></div>

  <!-- 顯示 Google 登入按鈕 -->
  <div class="g_id_signin"
       data-type="standard"
       data-shape="rectangular"
       data-theme="outline"
       data-text="sign_in_with"
       data-size="large"
       data-logo_alignment="left"></div>

<script>
  // 顯示小貼片
  function showWelcomeChip(name){
    const anchor = document.getElementById('onetap-anchor');
    if(!anchor) return;
    anchor.innerHTML = `<div class="welcome-chip">👋 歡迎 ${name}</div>`;
  }

  // 清掉小貼片
  function clearWelcomeChip(){
    const anchor = document.getElementById('onetap-anchor');
    if(anchor) anchor.innerHTML = '';
  }

  // Google 回傳 credential（JWT）後會呼叫這個函式
  window.handleCredentialResponse = (response) => {
    try {
      const token = response.credential;
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const json = decodeURIComponent(
        atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join('')
      );
      const payload = JSON.parse(json);

      // 存成 session
      const user = {
        email: payload.email,
        name: payload.name,
        picture: payload.picture,
        sub: payload.sub
      };
      localStorage.setItem('session_user', JSON.stringify(user));

      // 顯示 👋 歡迎
      showWelcomeChip(user.name);

      // 登入完成 → 回首頁或直接跳後台
      location.hash = '#dashboard';
      location.reload();
    } catch (e) {
      alert('Google 登入解析失敗：' + e);
    }
  };

  // 登出功能
  function logout(){
    try{ google.accounts.id.disableAutoSelect(); }catch(e){}
    localStorage.removeItem('session_user'); // 清掉 session
    clearWelcomeChip(); // 清掉貼片
    location.hash = '#auth'; // 回帳號頁
    location.reload();
  }

  // 讓你可以在 HTML 加一個登出按鈕用
  window.addEventListener('DOMContentLoaded', () => {
    const nav = document.querySelector('.nav');
    if(nav){
      const btn = document.createElement('button');
      btn.textContent = '登出';
      btn.onclick = logout;
      nav.appendChild(btn);
    }
  });
</script>

<header class="top">
  <div class="brand">SuperTool</div>
  <nav class="nav">
    <button data-route="dashboard">首頁</button>
    <button data-route="auth">帳號</button>
    <button data-route="expense">支出</button>
    <button data-route="acct_mine">我的</button>
    <button data-route="acct_detail">明細</button>
    <button data-route="acct_analysis">分析</button>
    <button data-route="chatbook">聊天記帳</button>
    <button data-route="camera">拍照記帳</button>
    <button data-route="shop">購物</button>
    <button data-route="admin">後台</button>
    <button data-route="settings">設定</button>
    <button data-route="backup">備份</button>
  </nav>
</header>
<main id="app"></main>

<button id="fabExpense" class="fab">＋</button>
<button id="fabShop" class="fab-square">🛒</button>

<script type="module" src="assets/js/app.js"></script>
<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
</body>
</html>
