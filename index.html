<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SuperTool Site</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/img/icon-192.png" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- Google Identity Services：只載一次 -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* 小貼片樣式（顯示在帳號卡片標題下、回首頁按鈕上） */
    .welcome-chip{
      display:inline-flex;align-items:center;gap:.4rem;
      background:#ffffff; color:#111; border-radius:999px;
      padding:.35rem .7rem; font-weight:700; box-shadow:0 2px 8px #0003;
      margin: .5rem 0 1rem 0;
    }
  </style>
</head>
  <!-- Google Identity Services：你已經有 -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Firebase SDK (v12 模組版) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithCredential,
    onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc,
    collection, addDoc, serverTimestamp,
    query, where, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  // === 1) Firebase 專案設定（換成你的） ===
  const firebaseConfig = {
    apiKey: "AIzaSyCjrjZOyMrzlbG2VOoRqd9o3q3X5HYv2WY",
    authDomain: "supertool-dee80.firebaseapp.com",
    projectId: "supertool-dee80",
    storageBucket: "supertool-dee80.firebasestorage.app",
    messagingSenderId: "577771534429",
    appId: "1:577771534429:web:7dc10a6082e9ab1cfd35b4"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // === 2) GSI callback：把 Google 的 JWT 交給 Firebase Auth ===
  window.handleCredentialResponse = async (res) => {
    try {
      const credential = GoogleAuthProvider.credential(res.credential);
      await signInWithCredential(auth, credential);
      // 會觸發 onAuthStateChanged
    } catch (err) {
      console.error('登入失敗：', err);
      alert('登入失敗，請稍後再試');
    }
  };

  // === 3) 監聽登入狀態 ===
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // 未登入 → 顯示登入按鈕
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('appBox').style.display   = 'none';
      return;
    }

    // 已登入 → 隱藏登入，顯示 app
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('appBox').style.display   = 'block';
    document.getElementById('hello').textContent = `嗨，${user.displayName || user.email}`;

    // 確保 users 文件存在（merge=true 可重複呼叫）
    const userRef = doc(db, 'users', user.uid);
    await setDoc(userRef, {
      uid: user.uid,
      name: user.displayName || '',
      email: user.email || '',
      picture: user.photoURL || '',
      updatedAt: serverTimestamp()
    }, { merge: true });

    // 啟動監聽目前使用者的記帳清單
    startListenMyExpenses(user.uid);
  });

  // === 4) 新增記帳 ===
  async function addExpense(evt) {
    evt.preventDefault();
    const user = auth.currentUser;
    if (!user) return alert('尚未登入');

    const amount   = Number(document.getElementById('fAmount').value || 0);
    const category = document.getElementById('fCategory').value.trim();
    const note     = document.getElementById('fNote').value.trim();

    if (!amount || !category) return alert('金額與分類必填');

    await addDoc(collection(db, 'expenses'), {
      uid: user.uid,
      amount,
      category,
      note,
      createdAt: serverTimestamp()
    });

    // 清空表單
    document.getElementById('expenseForm').reset();
  }

  document.getElementById('expenseForm').addEventListener('submit', addExpense);

  // === 5) 監聽自己的記帳 ===
  let unSub = null;
  function startListenMyExpenses(uid) {
    if (unSub) unSub(); // 先取消舊的監聽
    const q = query(
      collection(db, 'expenses'),
      where('uid', '==', uid),
      orderBy('createdAt', 'desc')
    );
    unSub = onSnapshot(q, (snap) => {
      const list = [];
      snap.forEach(doc => {
        const d = doc.data();
        list.push({
          id: doc.id,
          amount: d.amount,
          category: d.category,
          note: d.note || '',
          createdAt: d.createdAt?.toDate?.() || null
        });
      });
      renderExpenses(list);
    });
  }

  function renderExpenses(items) {
    const ul = document.getElementById('myList');
    ul.innerHTML = '';
    items.forEach(it => {
      const li = document.createElement('li');
      const d  = it.createdAt ? it.createdAt.toLocaleString() : '';
      li.textContent = `${d}｜${it.category}｜$${it.amount}｜${it.note}`;
      ul.appendChild(li);
    });
  }

  // === 6) 登出 ===
  document.getElementById('btnLogout').addEventListener('click', async () => {
    await signOut(auth);
  });
</script>

<body>
  <!-- 登入區塊 -->
<div id="loginBox" style="display:none; margin: 24px;">
  <h3>請用 Google 登入</h3>
  <!-- GSI：指定 callback -->
  <div id="g_id_onload"
       data-client_id="225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"></div>

  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="signin_with"
       data-shape="rectangular"
       data-logo_alignment="left"></div>
</div>

<!-- App 區塊 -->
<div id="appBox" style="display:none; margin: 24px;">
  <div style="display:flex; justify-content:space-between;">
    <h3 id="hello"></h3>
    <button id="btnLogout">登出</button>
  </div>

  <!-- 新增記帳 -->
  <form id="expenseForm" style="margin:12px 0;">
    <input id="fAmount" type="number" placeholder="金額" min="1" required />
    <input id="fCategory" type="text" placeholder="分類（如：餐飲）" required />
    <input id="fNote" type="text" placeholder="備註（可空白）" />
    <button type="submit">新增記帳</button>
  </form>

  <!-- 我的記帳清單 -->
  <ul id="myList"></ul>
</div>


<header class="top">
  <div class="brand">SuperTool</div>
  <nav class="nav">
    <button data-route="dashboard">首頁</button>
    <button data-route="auth">帳號</button>
    <button data-route="expense">支出</button>
    <button data-route="acct_mine">我的</button>
    <button data-route="acct_detail">明細</button>
    <button data-route="acct_analysis">分析</button>
    <button data-route="chatbook">聊天記帳</button>
    <button data-route="camera">拍照記帳</button>
    <button data-route="shop">購物</button>
    <button data-route="admin">後台</button>
    <button data-route="settings">設定</button>
    <button data-route="backup">備份</button>
  </nav>
</header>

<main id="app"></main>

<button id="fabExpense" class="fab">＋</button>
<button id="fabShop" class="fab-square">🛒</button>

<script type="module" src="assets/js/app.js"></script>

<script>
/* ------------------ 共用：JWT 解析（避免中文亂碼） ------------------ */
function parseGoogleJWT(credential){
  const base64Url = credential.split('.')[1];
  const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
  const json = decodeURIComponent(
    atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
  );
  return JSON.parse(json);
}

/* ------------------ 共用：在帳號卡片顯示歡迎 ------------------ */
window.__showWelcomeInAuth = function(name){
  // 優先找 #welcome-slot，找不到就自動建立到帳號卡片頂端
  let slot = document.getElementById('welcome-slot');
  if(!slot){
    const card = document.querySelector('#auth-card');
    if(card){
      slot = document.createElement('div');
      slot.id = 'welcome-slot';
      card.insertBefore(slot, card.firstChild ? card.firstChild.nextSibling : null);
    }
  }
  if(slot){
    slot.innerHTML = `<div class="welcome-chip">👋 歡迎 ${name}</div>`;
  }
};

/* ------------------ Google 初始化 & 登入回呼 ------------------ */
function handleCredentialResponse(res){
  try{
    const payload = parseGoogleJWT(res.credential);
    const user = {
      email:   payload.email,
      name:    payload.name,
      picture: payload.picture,
      sub:     payload.sub
    };
    localStorage.setItem('session_user', JSON.stringify(user));
    try{ google.accounts.id.cancel(); }catch(e){}

    // 若目前在帳號頁，直接顯示歡迎
    window.__showWelcomeInAuth && window.__showWelcomeInAuth(user.name);

    // 通知頁面（若你有路由或需要刷新）
    if(location.hash === '#auth'){
      // 不重整也可，只要你的 SPA 會讀 localStorage 就好
    }else{
      // 登入完直接回首頁（選用）
      location.hash = '#dashboard';
    }
  }catch(e){
    console.error('解析 Google Token 失敗：', e);
  }
}

function initGoogle(){
  if(!window.google || !google.accounts || !google.accounts.id) return;

  google.accounts.id.initialize({
    client_id: "225238850447-tds4p75o2nsforov086amnrj1nha7tuh.apps.googleusercontent.com",
    callback: handleCredentialResponse,
    auto_select: false,           // ❌ 不自動 One-Tap
    cancel_on_tap_outside: true   // ❌ 不顯示左上角膠囊
  });

  // 把 renderButton 變成全域可呼叫（在 auth.js 會使用）
  window.__renderGoogleBtn = function(){
    const mount = document.getElementById('googleBtnMount') || document.querySelector('.g_id_signin');
    if(mount){
      google.accounts.id.renderButton(mount, { theme: "outline", size: "large" });
    }
  };

  // 若已登入，切到帳號頁時顯示歡迎；未登入則渲染按鈕
  function refreshAuthUI(){
    let user = null;
    try{ user = JSON.parse(localStorage.getItem('session_user') || 'null'); }catch{}
    if(location.hash === '#auth'){
      if(user && user.name){
        window.__showWelcomeInAuth && window.__showWelcomeInAuth(user.name);
      }else{
        window.__renderGoogleBtn && window.__renderGoogleBtn();
      }
    }
  }

  // 首次載入
  refreshAuthUI();

  // hash 變化時再檢查一次
  window.addEventListener('hashchange', refreshAuthUI);
}

window.addEventListener('load', () => {
  // 初始化 GSI
  const ready = () => initGoogle();
  if(window.google && google.accounts && google.accounts.id){ ready(); }
  else {
    // 等 script 載入完成
    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      if(window.google && google.accounts && google.accounts.id){
        clearInterval(timer);
        ready();
      }else if(tries > 50){ // 最多等 5 秒
        clearInterval(timer);
      }
    }, 100);
  }
});
</script>

<script>
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
</body>
</html>
