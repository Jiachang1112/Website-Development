<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cart Demo</title>

  <!-- Bootstrap Iconsï¼ˆåªç”¨åˆ°è³¼ç‰©è»Šåœ–ç¤ºï¼‰ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    /* ===== ç‰ˆé¢èˆ‡å¡ç‰‡ ===== */
    :root { color-scheme: dark; }
    body{
      margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:#0f1318; color:#e6e6e6;
    }
    .container{ max-width:1200px; margin:0 auto; padding:24px 16px; }
    .title{ font-size:24px; font-weight:800; margin:8px 0 16px; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:16px; }
    .card{
      border:1px solid #2a2f37; border-radius:12px; padding:16px;
      background:#151a21; box-shadow: 0 8px 30px #0008;
    }
    .btn{
      border:1px solid #444; background:#1b1f26; color:#e6e6e6;
      border-radius:8px; padding:.5rem .8rem; cursor:pointer;
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn-primary{ background:#3b82f6; border-color:#3b82f6; }
    .btn-secondary{ background:#334155; border-color:#334155; }
    .btn-danger{ background:#ef4444; border-color:#ef4444; }

    .price{ font-weight:700; }
    .text-muted{ color:#9aa0a6; }

    /* ===== å³å´è³¼ç‰©è»Š Panel ===== */
    .cart-mask{
      position:fixed; inset:0; background:#0007; opacity:0; pointer-events:none; transition:.25s; z-index:8888;
    }
    .cart-mask.open{ opacity:1; pointer-events:auto; }
    .cart-panel{
      position:fixed; top:0; right:0; height:100vh; width:380px;
      background:#111; color:#eee; border-left:1px solid #333;
      transform: translateX(100%); transition:.25s; z-index:8890;
      display:flex; flex-direction:column;
      box-shadow:-8px 0 24px #0008;
    }
    .cart-panel.open{ transform:none; }
    .cart-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #333; }
    .cart-body{ flex:1; overflow:auto; padding:16px; }
    .cart-foot{ border-top:1px solid #333; padding:12px 16px; }
    .cart-row{ display:flex; align-items:center; justify-content:space-between; padding:6px 0; }
    .qty-btn{ width:28px; height:28px; display:grid; place-items:center; border:1px solid #444; border-radius:6px; background:#1b1f26; cursor:pointer; }

    /* ===== å³ä¸‹è§’æµ®å‹•è³¼ç‰©è»ŠæŒ‰éˆ• ===== */
    #fabShop{
      position:fixed; right:16px; bottom:16px; z-index:9000;
      width:56px; height:56px; border-radius:50%;
      display:grid; place-items:center; background:#3b82f6; border:none; color:#fff; font-size:22px;
      box-shadow:0 8px 30px #0008; cursor:pointer;
    }
    #fabShop .badge-dot{
      position:absolute; top:-4px; right:-4px; background:#ef4444; color:#fff;
      border-radius:999px; font-size:12px; line-height:18px; min-width:18px; height:18px;
      display:grid; place-items:center; padding:0 4px; border:2px solid #0f1318;
    }

    /* ===== Checkout Modalï¼ˆç°¡æ˜“ï¼‰ ===== */
    .modal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);
      z-index:9999; display:flex; align-items:center; justify-content:center;
    }
    .modal-content{
      background:#0f1318; color:#e6e6e6; border:1px solid #333; border-radius:8px; padding:20px;
      width:90%; max-width:520px; box-shadow:0 20px 60px #000a;
    }
    .form-control, .form-select{
      width:100%; background:#141a22; color:#eee; border:1px solid #2a2f37; border-radius:8px;
      padding:.55rem .7rem; outline:none;
    }
    .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .mt-2{ margin-top:.5rem; }
    .mt-3{ margin-top:.75rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">å•†å“åˆ—è¡¨</div>
    <div id="products" class="grid"></div>
  </div>

  <!-- å³ä¸‹è§’æµ®å‹•è³¼ç‰©è»Š -->
  <button id="fabShop" title="è³¼ç‰©è»Š">
    <i class="bi bi-cart"></i>
  </button>

  <!-- è³¼ç‰©è»Šï¼šé®ç½© + å³å´é¢æ¿ -->
  <div id="cartMask" class="cart-mask"></div>
  <aside id="cartPanel" class="cart-panel" aria-hidden="true">
    <div class="cart-head">
      <div>è³¼ç‰©è»Š</div>
      <button id="cartClose" class="btn btn-secondary">é—œé–‰</button>
    </div>
    <div id="cartItems" class="cart-body">
      <div class="text-muted">å°šç„¡å•†å“</div>
    </div>
    <div class="cart-foot">
      <div class="cart-row"><span class="text-muted">å°è¨ˆ</span><span id="cartSubtotal">NT$ 0</span></div>
      <div class="cart-row"><span class="text-muted">é‹è²»</span><span id="cartShipping">NT$ 0</span></div>
      <div class="cart-row"><span>åˆè¨ˆ</span><span id="cartTotal">NT$ 0</span></div>
      <div class="cart-row" style="gap:8px">
        <button id="cartClear" class="btn btn-secondary">æ¸…ç©º</button>
        <button id="checkoutBtn" class="btn btn-primary" style="flex:1">çµå¸³</button>
      </div>
    </div>
  </aside>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="modal" role="dialog" aria-modal="true">
    <form id="checkoutForm" class="modal-content">
      <h3 style="margin:0 0 .5rem;">è¨‚è³¼è³‡æ–™</h3>
      <div class="form-row mt-2">
        <div>
          <label class="text-muted">å§“å</label>
          <input name="name" class="form-control" required>
        </div>
        <div>
          <label class="text-muted">é›»è©±</label>
          <input name="phone" class="form-control" required>
        </div>
      </div>
      <div class="mt-2">
        <label class="text-muted">Emailï¼ˆæ”¶è¨‚å–®ï¼‰</label>
        <input name="email" type="email" class="form-control" required>
      </div>
      <div class="mt-2">
        <label class="text-muted">é…é€æ–¹å¼</label>
        <select name="shipping" class="form-select" required>
          <option value="å®…é…">å®…é…ï¼ˆé»‘è²“/æ–°ç«¹ï¼‰</option>
          <option value="è¶…å•†å–è²¨ï¼ˆå…ˆåŒ¯æ¬¾ï¼‰">è¶…å•†å–è²¨ï¼ˆå…ˆåŒ¯æ¬¾ï¼‰</option>
        </select>
      </div>
      <div class="mt-2">
        <label class="text-muted">åœ°å€/é–€å¸‚</label>
        <input name="address" class="form-control" required>
      </div>
      <div class="mt-2">
        <label class="text-muted">ä»˜æ¬¾æ–¹å¼</label>
        <select name="payment" class="form-select" required>
          <option value="éŠ€è¡Œè½‰å¸³">éŠ€è¡Œè½‰å¸³</option>
          <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
          <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡ï¼ˆç¶ ç•Œ/è—æ–°ï¼‰</option>
        </select>
      </div>
      <div class="mt-2">
        <label class="text-muted">å‚™è¨»</label>
        <textarea name="note" rows="3" class="form-control" placeholder="å°ºå¯¸ã€ç™¼ç¥¨æŠ¬é ­/çµ±ç·¨ç­‰"></textarea>
      </div>
      <div class="mt-3" style="display:flex; gap:8px; justify-content:flex-end">
        <button type="button" id="closeModal" class="btn btn-secondary">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">é€å‡ºè¨‚å–®</button>
      </div>
    </form>
  </div>

  <script>
    /* ========= ç°¡æ˜“è³‡æ–™ / å·¥å…· ========= */
    const fmt = n => 'NT$ ' + (n||0).toLocaleString();

    // ç”¢ 50 å€‹ç¤ºä¾‹å•†å“ï¼ˆå¯æ”¹æˆä½ çš„å“é …ï¼‰
    const PRODUCTS = Array.from({length:50}, (_,i)=>{
      const n2 = String(i+1).padStart(2,'0');
      const n3 = String(i+1).padStart(3,'0');
      return {
        sku: `P-${n3}`,
        name: `å•†å“ ${n2}`,
        price: (i+1)*100,
        image: `/assets/product-${n2}.jpg` // æ²’åœ–æœƒ fallback
      };
    });

    /* ========= è³¼ç‰©è»Šï¼ˆlocalStorageï¼‰ ========= */
    const CART_KEY = 'cart';
    const $ = sel => document.querySelector(sel);

    function loadCart(){
      try{ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); }
      catch{ return []; }
    }
    function saveCart(cart){
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      updateBadge();
    }

    function updateBadge(){
      const btn = $('#fabShop');
      if(!btn) return;
      let badge = btn.querySelector('.badge-dot');
      const cart = loadCart();
      const count = cart.reduce((s,i)=>s+i.qty,0);
      if(!badge){
        badge = document.createElement('span');
        badge.className = 'badge-dot';
        btn.appendChild(badge);
      }
      badge.textContent = count;
      badge.style.display = count>0 ? 'grid' : 'none';
    }

    function addToCart(p){
      const cart = loadCart();
      const found = cart.find(i=>i.sku===p.sku);
      if(found) found.qty++;
      else cart.push({ sku:p.sku, name:p.name, price:p.price, qty:1 });
      saveCart(cart); renderCart();
    }
    function changeQty(sku, delta){
      const cart = loadCart();
      const item = cart.find(i=>i.sku===sku);
      if(!item) return;
      item.qty += delta;
      if(item.qty<=0) cart.splice(cart.indexOf(item),1);
      saveCart(cart); renderCart();
    }
    function clearCart(){
      localStorage.removeItem(CART_KEY);
      renderCart(); updateBadge();
    }

    function renderCart(){
      const cart = loadCart();
      $('#cartItems').innerHTML = cart.length ? cart.map(i=>`
        <div class="cart-row" style="align-items:flex-start">
          <div>
            <div style="font-weight:700">${i.name}</div>
            <div class="text-muted">SKUï¼š${i.sku}</div>
          </div>
          <div>${fmt(i.price*i.qty)}</div>
        </div>
        <div class="cart-row" style="gap:8px">
          <button class="qty-btn" onclick="changeQty('${i.sku}',-1)">ï¼</button>
          <div class="text-muted">x ${i.qty}</div>
          <button class="qty-btn" onclick="changeQty('${i.sku}',+1)">ï¼‹</button>
        </div>
      `).join('') : '<div class="text-muted">å°šç„¡å•†å“</div>';

      const subtotal = cart.reduce((s,i)=>s+i.price*i.qty,0);
      const shipping = (subtotal>2000 || subtotal===0) ? 0 : 100;
      $('#cartSubtotal').textContent = fmt(subtotal);
      $('#cartShipping').textContent = fmt(shipping);
      $('#cartTotal').textContent = fmt(subtotal+shipping);
      updateBadge();
    }

    /* ========= Panel / Modal æ§åˆ¶ ========= */
    function openCart(){ $('#cartPanel').classList.add('open'); $('#cartMask').classList.add('open'); }
    function closeCart(){ $('#cartPanel').classList.remove('open'); $('#cartMask').classList.remove('open'); }

    function openCheckout(){ $('#checkoutModal').style.display='flex'; }
    function closeCheckout(){ $('#checkoutModal').style.display='none'; }

    /* ========= DOM ç¶å®š ========= */
    // å•†å“åˆ—è¡¨
    $('#products').innerHTML = PRODUCTS.slice(0,8).map(p=>`
      <div class="card">
        <div style="font-weight:600">${p.name}</div>
        <div class="text-muted" style="font-size:12px">SKUï¼š${p.sku}</div>
        <div class="price" style="margin:.5rem 0">${fmt(p.price)}</div>
        <button class="btn" onclick='addToCart(${JSON.stringify(p)})'>åŠ å…¥è³¼ç‰©è»Š</button>
      </div>
    `).join('');

    // panel èˆ‡æŒ‰éˆ•
    $('#fabShop').addEventListener('click', openCart);
    $('#cartClose').addEventListener('click', closeCart);
    $('#cartMask').addEventListener('click', closeCart);
    $('#cartClear').addEventListener('click', clearCart);
    $('#checkoutBtn').addEventListener('click', ()=>{
      closeCart(); openCheckout();
    });

    // checkout è¡¨å–®
    $('#closeModal').addEventListener('click', closeCheckout);
    $('#checkoutForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const cart = loadCart();
      if(!cart.length){ alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return; }
      const data = Object.fromEntries(new FormData(e.target).entries());
      const order = {
        id: 'OD' + Date.now(),
        customer: data,
        items: cart,
        amount: $('#cartTotal').textContent
      };
      console.log('ğŸ§¾ è¨‚å–®ï¼š', order);
      alert(`è¨‚å–®å·²é€å‡ºï¼š${order.id}\nï¼ˆé€™è£¡å¯ä»¥æ”¹æˆå°å‘ /checkout.html æˆ–æ‰“ API å»ºç«‹è¨‚å–®ï¼‰`);
      closeCheckout();
      clearCart();
    });

    // åˆå§‹é¡¯ç¤º
    renderCart();
  </script>
</body>
</html>
